<!doctype html>
<html lang="ru">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>CRM промо‑коды</title>
	<style>
		:root {
			--bg: #0b0e14;
			--panel: #121723;
			--muted: #8a93a6;
			--text: #e6ebf2;
			--accent: #6aa1ff;
			--ok: #39d353;
			--err: #ff6b6b;
			--border: #202534;
			--chip: #1b2233;
		}

		@media (prefers-color-scheme: light) {
			:root {
				--bg: #f7f9fc;
				--panel: #fff;
				--muted: #667085;
				--text: #0f172a;
				--accent: #2563eb;
				--ok: #15803d;
				--err: #dc2626;
				--border: #e5e7eb;
				--chip: #eef2ff;
			}
		}

		* {
			box-sizing: border-box;
		}

		body {
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
			margin: 0;
			background: var(--bg);
			color: var(--text);
		}

		.container {
			max-width: 1100px;
			margin: 0 auto;
			padding: 24px;
		}

		.header {
			position: sticky;
			top: 0;
			background: rgba(0, 0, 0, 0.25);
			backdrop-filter: blur(8px);
			border-bottom: 1px solid var(--border);
		}

		.header-inner {
			max-width: 1100px;
			margin: 0 auto;
			padding: 14px 24px;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.header h1 {
			font-size: 18px;
			margin: 0;
			letter-spacing: 0.2px;
		}

		.toolbar {
			margin-left: auto;
			display: flex;
			gap: 8px;
		}

		.btn {
			background: var(--panel);
			border: 1px solid var(--border);
			color: var(--text);
			padding: 8px 12px;
			border-radius: 8px;
			cursor: pointer;
		}

		.btn:hover {
			border-color: var(--accent);
		}

		.btn.primary {
			background: var(--accent);
			color: #fff;
			border-color: var(--accent);
		}

		h2 {
			margin: 0 0 8px 0;
			font-size: 16px;
		}

		.grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 16px;
		}

		textarea,
		input,
		select,
		button {
			font-size: 16px;
		}

		textarea {
			width: 100%;
			min-height: 120px;
			background: var(--panel);
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: 10px;
			padding: 10px;
		}

		input[type="text"],
		input[type="number"],
		select {
			width: 100%;
			background: var(--panel);
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: 10px;
			padding: 10px;
		}

		table {
			border-collapse: collapse;
			width: 100%;
		}

		th,
		td {
			border-bottom: 1px solid var(--border);
			padding: 10px 8px;
			font-size: 14px;
			text-align: left;
		}

		th.sortable {
			cursor: pointer;
		}

		th.sortable span {
			color: var(--muted);
			font-weight: normal;
		}

		.row {
			display: flex;
			gap: 8px;
			align-items: center;
		}

		.muted {
			color: var(--muted);
		}

		.ok {
			color: var(--ok);
		}

		.err {
			color: var(--err);
		}

		.badge {
			background: var(--chip);
			border: 1px solid var(--border);
			border-radius: 999px;
			padding: 2px 8px;
			font-size: 12px;
		}

		.card {
			background: var(--panel);
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 16px;
		}

		.actions {
			display: flex;
			gap: 8px;
		}

		.link {
			color: var(--accent);
			text-decoration: none;
		}

		.table-actions {
			display: flex;
			gap: 6px;
		}

		.kpis {
			display: flex;
			gap: 12px;
			margin: 12px 0 0 0;
		}

		.kpi {
			background: var(--panel);
			border: 1px solid var(--border);
			border-radius: 10px;
			padding: 8px 12px;
		}

		.pagination {
			display: flex;
			gap: 6px;
			align-items: center;
			justify-content: flex-end;
			padding-top: 10px;
		}

		@media (max-width: 900px) {
			.grid {
				grid-template-columns: 1fr;
			}

			.toolbar {
				flex-wrap: wrap;
			}
		}
	</style>
</head>

<body>
	<div class="header">
		<div class="header-inner">
			<h1>CRM промо‑коды</h1>
			<div class="toolbar">
				<button class="btn" id="refreshTop">Обновить</button>
				<button class="btn" id="exportJson">Экспорт JSON</button>
				<button class="btn" id="exportCsv">Экспорт CSV</button>
				<a class="btn" href="/activate.html">Активация</a>
			</div>
		</div>
	</div>
	<div class="container">
		<div class="muted">Создание и учет промо‑кодов. Локальный тест без отправки писем.</div>
		<div class="grid" style="margin-top:16px">
			<div class="card">
				<h2>Сгенерировать промо‑коды</h2>
				<div class="row">
					<label>Количество</label>
					<input id="count" type="number" min="1" max="500" value="5" />
					<label>Префикс</label>
					<input id="prefix" type="text" placeholder="например, SPRING" />
				</div>
				<div class="row" style="margin-top:8px">
					<label>Тег/Продукт</label>
					<input id="tag" type="text" placeholder="basic, pro, ..." />
				</div>
				<div class="actions" style="margin-top:12px">
					<button class="btn primary" id="gen">Сгенерировать</button>
					<span id="gen-status" class="muted"></span>
				</div>
			</div>

			<div class="card">
				<h2>Импорт из списка</h2>
				<textarea id="bulk" placeholder="По одному коду на строку, опционально через запятую: CODE,tag"></textarea>
				<div class="actions" style="margin-top:8px">
					<button class="btn" id="import">Импортировать</button>
					<span id="import-status" class="muted"></span>
				</div>
			</div>
		</div>

		<div class="card" style="margin-top:16px">
			<div class="row" style="justify-content: space-between; align-items: flex-end; gap:12px; flex-wrap: wrap;">
				<div>
					<h2 style="margin-bottom:6px">Список кодов</h2>
					<div class="kpis">
						<div class="kpi"><span class="muted">Всего:</span> <strong id="kpi-total">0</strong></div>
						<div class="kpi"><span class="muted">Свободно:</span> <strong id="kpi-free">0</strong></div>
						<div class="kpi"><span class="muted">Использовано:</span> <strong id="kpi-used">0</strong></div>
					</div>
				</div>
				<div class="row" style="gap:8px; flex-wrap: wrap;">
					<input id="f-search" type="text" placeholder="Поиск по коду/тегу" style="min-width:220px" />
					<select id="f-status" style="min-width:180px">
						<option value="all">Статус: все</option>
						<option value="free">Только свободные</option>
						<option value="used">Только использованные</option>
					</select>
					<input id="f-tag" type="text" placeholder="Фильтр по тегу" style="min-width:180px" />
					<button class="btn" id="clearFilters">Сбросить</button>
				</div>
			</div>
			<div id="list-status" class="muted" style="margin-top:10px">Загрузка…</div>
			<table id="codes-table" style="display:none; margin-top:6px">
				<thead>
					<tr>
						<th style="width:36px"><input type="checkbox" id="selectAll" /></th>
						<th class="sortable" data-col="code">Код <span id="sort-code"></span></th>
						<th class="sortable" data-col="tag" style="width:200px">Тег <span id="sort-tag"></span></th>
						<th class="sortable" data-col="status" style="width:140px">Статус <span id="sort-status"></span></th>
						<th style="width:280px">Кем/когда</th>
						<th style="width:180px">Действия</th>
					</tr>
				</thead>
				<tbody id="codes-body"></tbody>
			</table>
			<div class="pagination" id="pager" style="display:none">
				<button class="btn" id="prevPage">‹</button>
				<span class="muted">Стр. <span id="pageCur">1</span> из <span id="pageMax">1</span></span>
				<button class="btn" id="nextPage">›</button>
			</div>
			<div class="actions" style="margin-top:8px">
				<button class="btn" id="bulkRedeem">Отметить выбранные использованными</button>
				<span id="bulk-status" class="muted"></span>
			</div>
		</div>
	</div>

	<script>
		const api = (path, options = {}) => fetch(`/api/${path}`, { headers: { 'Content-Type': 'application/json' }, ...options }).then(r => r.json());

		const state = { codes: [], filtered: [], sortCol: 'code', sortDir: 'asc', page: 1, pageSize: 25, filters: { search: '', status: 'all', tag: '' } };

		function computeKpis(list) {
			const total = list.length;
			const used = list.filter(x => x.used).length;
			const free = total - used;
			document.getElementById('kpi-total').textContent = total;
			document.getElementById('kpi-free').textContent = free;
			document.getElementById('kpi-used').textContent = used;
		}

		function applyFilters() {
			let list = [...state.codes];
			const q = state.filters.search.toLowerCase();
			if (q) list = list.filter(c => (c.code || '').toLowerCase().includes(q) || (c.tag || '').toLowerCase().includes(q));
			if (state.filters.status === 'free') list = list.filter(c => !c.used);
			if (state.filters.status === 'used') list = list.filter(c => c.used);
			if (state.filters.tag) list = list.filter(c => (c.tag || '').toLowerCase().includes(state.filters.tag.toLowerCase()));
			state.filtered = list;
			computeKpis(list);
			applySort();
		}

		function applySort() {
			const col = state.sortCol; const dir = state.sortDir === 'asc' ? 1 : -1;
			state.filtered.sort((a, b) => {
				let av, bv;
				if (col === 'status') { av = a.used ? 1 : 0; bv = b.used ? 1 : 0; }
				else { av = (a[col] || '').toString().toLowerCase(); bv = (b[col] || '').toString().toLowerCase(); }
				if (av < bv) return -1 * dir; if (av > bv) return 1 * dir; return 0;
			});
			renderTable();
			updateSortIcons();
		}

		function updateSortIcons() {
			['code', 'tag', 'status'].forEach(c => { const el = document.getElementById('sort-' + c); if (!el) return; el.textContent = (state.sortCol === c ? (state.sortDir === 'asc' ? '▲' : '▼') : ''); });
		}

		function renderTable() {
			const tbody = document.getElementById('codes-body');
			tbody.innerHTML = '';
			const start = (state.page - 1) * state.pageSize;
			const pageItems = state.filtered.slice(start, start + state.pageSize);
			for (const c of pageItems) {
				const tr = document.createElement('tr');
				const statusText = c.used ? 'Использован' : 'Свободен';
				const statusBadge = `<span class="badge" style="background:${c.used ? '#2d1f25' : '#16251a'}; border-color: var(--border); color:${c.used ? 'var(--err)' : 'var(--ok)'}">${statusText}</span>`;
				const meta = c.usedBy ? `${c.usedBy} / ${c.usedAt || ''}` : '';
				tr.innerHTML = `
					<td><input type="checkbox" class="rowSel" data-code="${c.code}" ${c.used ? 'disabled' : ''}/></td>
					<td><code>${c.code}</code></td>
					<td>${c.tag || ''}</td>
					<td>${statusBadge}</td>
					<td>${meta}</td>
					<td>
						<div class="table-actions">
							<button class="btn" data-action="copy" data-code="${c.code}">Копировать</button>
							${c.used ? '' : `<button class="btn" data-action="redeem" data-code="${c.code}">Отметить</button>`}
						</div>
					</td>`;
				tbody.appendChild(tr);
			}
			document.getElementById('codes-table').style.display = state.filtered.length ? '' : 'none';
			document.getElementById('list-status').textContent = state.filtered.length ? `${state.filtered.length} шт.` : 'Пусто';
			const pages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
			document.getElementById('pager').style.display = pages > 1 ? '' : 'none';
			document.getElementById('pageCur').textContent = state.page;
			document.getElementById('pageMax').textContent = pages;
		}

		async function loadList() {
			document.getElementById('list-status').textContent = 'Загрузка…';
			document.getElementById('codes-table').style.display = 'none';
			const res = await api('codes');
			state.codes = res.codes || [];
			state.page = 1;
			applyFilters();
		}

		function exportJson(data) {
			const blob = new Blob([JSON.stringify({ codes: data }, null, 2)], { type: 'application/json' });
			const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'codes.json'; a.click(); URL.revokeObjectURL(url);
		}

		function exportCsv(data) {
			const header = ['code', 'tag', 'used', 'usedAt', 'usedBy'];
			const rows = data.map(c => [c.code, c.tag || '', c.used ? 1 : 0, c.usedAt || '', c.usedBy || '']);
			const csv = [header.join(','), ...rows.map(r => r.map(x => '"' + String(x).replaceAll('"', '""') + '"').join(','))].join('\n');
			const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
			const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'codes.csv'; a.click(); URL.revokeObjectURL(url);
		}

		document.getElementById('gen').onclick = async () => {
			const count = Number(document.getElementById('count').value || '1');
			const prefix = document.getElementById('prefix').value.trim();
			const tag = document.getElementById('tag').value.trim();
			document.getElementById('gen-status').textContent = 'Генерация…';
			const res = await api('generate', { method: 'POST', body: JSON.stringify({ count, prefix, tag }) });
			document.getElementById('gen-status').textContent = res.error ? res.error : `Добавлено: ${res.added}`;
			if (!res.error) loadList();
		};

		document.getElementById('import').onclick = async () => {
			const raw = document.getElementById('bulk').value.trim(); if (!raw) return;
			document.getElementById('import-status').textContent = 'Импорт…';
			const lines = raw.split(/\n+/).map(l => l.trim()).filter(Boolean);
			const entries = lines.map(l => { const [code, tag] = l.split(',').map(p => (p || '').trim()); return { code, tag }; });
			const res = await api('import', { method: 'POST', body: JSON.stringify({ entries }) });
			document.getElementById('import-status').textContent = res.error ? res.error : `Импортировано: ${res.added}`;
			if (!res.error) { document.getElementById('bulk').value = ''; loadList(); }
		};

		document.getElementById('refreshTop').onclick = loadList;
		document.getElementById('exportJson').onclick = () => exportJson(state.codes);
		document.getElementById('exportCsv').onclick = () => exportCsv(state.codes);

		document.getElementById('f-search').oninput = (e) => { state.filters.search = e.target.value; state.page = 1; applyFilters(); };
		document.getElementById('f-status').onchange = (e) => { state.filters.status = e.target.value; state.page = 1; applyFilters(); };
		document.getElementById('f-tag').oninput = (e) => { state.filters.tag = e.target.value; state.page = 1; applyFilters(); };
		document.getElementById('clearFilters').onclick = () => { state.filters = { search: '', status: 'all', tag: '' }; document.getElementById('f-search').value = ''; document.getElementById('f-status').value = 'all'; document.getElementById('f-tag').value = ''; state.page = 1; applyFilters(); };

		document.getElementById('codes-table').addEventListener('click', async (e) => {
			const t = e.target; if (!(t instanceof HTMLElement)) return;
			if (t.dataset.action === 'copy') { await navigator.clipboard.writeText(String(t.dataset.code || '')); t.textContent = 'Скопировано'; setTimeout(() => t.textContent = 'Копировать', 1200); }
			if (t.dataset.action === 'redeem') {
				t.textContent = '...';
				const res = await api('redeem', { method: 'POST', body: JSON.stringify({ code: t.dataset.code, usedBy: 'crm' }) });
				if (res && !res.error) { loadList(); } else { t.textContent = 'Ошибка'; setTimeout(() => t.textContent = 'Отметить', 1200); }
			}
		});

		document.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => {
			const col = th.getAttribute('data-col'); if (!col) return;
			if (state.sortCol === col) state.sortDir = (state.sortDir === 'asc' ? 'desc' : 'asc'); else { state.sortCol = col; state.sortDir = 'asc'; }
			applySort();
		}));

		document.getElementById('prevPage').onclick = () => { if (state.page > 1) { state.page--; renderTable(); } };
		document.getElementById('nextPage').onclick = () => { const pages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize)); if (state.page < pages) { state.page++; renderTable(); } };

		document.getElementById('selectAll').onchange = (e) => { const on = e.target.checked; document.querySelectorAll('.rowSel').forEach(cb => { if (!cb.disabled) cb.checked = on; }); };
		document.getElementById('bulkRedeem').onclick = async () => {
			const cbs = Array.from(document.querySelectorAll('.rowSel')).filter(cb => cb.checked);
			if (!cbs.length) { document.getElementById('bulk-status').textContent = 'Ничего не выбрано'; return; }
			document.getElementById('bulk-status').textContent = 'Отмечаю…';
			let ok = 0;
			for (const cb of cbs) {
				const code = cb.getAttribute('data-code');
				const res = await api('redeem', { method: 'POST', body: JSON.stringify({ code, usedBy: 'crm-bulk' }) });
				if (res && !res.error) ok++;
			}
			document.getElementById('bulk-status').textContent = `Отмечено: ${ok}`;
			loadList();
		};

		loadList();
	</script>
</body>

</html>